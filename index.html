<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007aff">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Cr√©dits">
<link rel="apple-touch-icon" href="icon-192.png">

<meta charset="UTF-8">
<title>Simulation cr√©dits immo & conso</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
html, body { height:100%; margin:0; padding:0; }
body { font-family:Arial; background:#f4f6f8; }
.box { background:white; padding:16px; min-height:100vh; position: relative; }

input, select, button {
  padding:10px;
  margin:3px;
  width:100%;
  font-size:16px;
}

.hidden { display:none; }

.table-container { overflow-x:auto; }

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  margin-top:20px;
}

th, td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}

th { background:#eee; }

button {
  background:#007aff;
  color:white;
  border:none;
  border-radius:5px;
}

.delete { background:red; }
.edit { background:orange; }
.pos { color:green; font-weight:bold; }
.neg { color:red; font-weight:bold; }

/* GRAPH */
#graph {
  width:100% !important;
  height:300px !important;
}

.result {
  margin-top:15px;
  font-size:18px;
  font-weight:bold;
}

/* MENU PROFIL */
#openProfileMenu {
  position:fixed;
  top:10px;
  left:10px;
  z-index:1000;
  width:auto;
  padding:8px 12px;
}

#profileMenu {
  position:fixed;
  top:0;
  left:-320px;
  width:300px;
  height:100%;
  background:#fff;
  box-shadow:2px 0 10px rgba(0,0,0,.2);
  padding:15px;
  z-index:1001;
  transition:left .3s;
  overflow-y:auto;
}

/* L√âGENDE */
.legend-vertical {
  position:absolute;
  right:5px;
  top:0;
  bottom:0;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  pointer-events:none;
}

.legend-item {
  writing-mode:vertical-rl;
  transform:rotate(180deg);
  font-weight:bold;
  font-size:11px;
}

.legend-item.salaire { color:gold; }
.legend-item.cashflow-pos { color:green; }
.legend-item.cashflow-neg { color:red; }
</style>
</head>

<body>

<!-- BOUTON PROFIL -->
<button id="openProfileMenu">‚ò∞ Profil</button>

<!-- MENU PROFIL -->
<div id="profileMenu">
<h3>Profil financier</h3>

<select id="profileSelect"></select>

<input id="profileName" placeholder="Nom du profil">
<input id="profileSalaire" type="number" placeholder="Salaire mensuel (‚Ç¨)">
<input id="profileCharges" type="number" placeholder="Charges fixes mensuelles (‚Ç¨)">

<button onclick="saveProfile()">Enregistrer / Modifier</button>
<button class="delete" onclick="deleteProfile()">Supprimer</button>

<hr>
<button onclick="toggleProfileMenu()">Fermer</button>
</div>

<div class="box">
<h2>Simulation cr√©dits (immobilier & conso)</h2>

<input id="salaire" type="hidden">
<input id="tauxLoyer" type="number" value="70" placeholder="% loyer retenu">

<hr>

<input id="nom" placeholder="Nom du projet">

<select id="type" onchange="changerType()">
  <option value="immo">Cr√©dit immobilier</option>
  <option value="conso">Cr√©dit conso</option>
</select>

<div id="blocImmo">
  <input id="prix" type="number" placeholder="Prix d'achat">
  <input id="apport" type="number" placeholder="Apport personnel">
  <input id="loyer" type="number" placeholder="Loyer mensuel">
</div>

<div id="blocConso" class="hidden">
  <input id="creditConso" type="number" placeholder="Montant du cr√©dit conso">
</div>

<input id="taux" type="number" step="0.01" placeholder="Taux %">
<input id="duree" type="number" placeholder="Dur√©e (ann√©es)">

<button onclick="ajouter()">Ajouter la ligne</button>
<button onclick="exportPDF()">Exporter en PDF</button>

<div class="table-container">
<table>
<thead>
<tr>
<th>Projet</th><th>Type</th><th>Prix</th><th>Apport</th><th>Notaire</th>
<th>Apport total</th><th>Cr√©dit</th><th>Taux</th><th>Dur√©e</th>
<th>Loyer</th><th>Mensualit√©</th><th>Endettement</th><th>Cashflow</th><th>Action</th>
</tr>
</thead>
<tbody id="lignes"></tbody>
</table>
</div>

<div class="result">
Reste √† vivre mensuel :
<span id="revenuFinalGlobal">0 ‚Ç¨</span>
</div>

<div class="graph-wrapper">
  <canvas id="graph"></canvas>
  <div class="legend-vertical">
    <div class="legend-item salaire">Salaire net</div>
    <div class="legend-item cashflow-pos">Cashflow positif</div>
    <div class="legend-item cashflow-neg">Cashflow n√©gatif</div>
  </div>
</div>
</div>

<script>
/* DOM */
const salaireEl=document.getElementById("salaire");
const tauxLoyerEl=document.getElementById("tauxLoyer");
const nomEl=document.getElementById("nom");
const typeEl=document.getElementById("type");
const blocImmoEl=document.getElementById("blocImmo");
const blocConsoEl=document.getElementById("blocConso");
const prixEl=document.getElementById("prix");
const apportEl=document.getElementById("apport");
const loyerEl=document.getElementById("loyer");
const creditConsoEl=document.getElementById("creditConso");
const tauxEl=document.getElementById("taux");
const dureeEl=document.getElementById("duree");
const lignesEl=document.getElementById("lignes");
const revenuFinalEl=document.getElementById("revenuFinalGlobal");
const graphEl=document.getElementById("graph");

const profileMenu=document.getElementById("profileMenu");
const profileSelect=document.getElementById("profileSelect");
const profileName=document.getElementById("profileName");
const profileSalaire=document.getElementById("profileSalaire");
const profileCharges=document.getElementById("profileCharges");

/* DATA */
let data=JSON.parse(localStorage.getItem("credits_data"))||[];
let profiles=JSON.parse(localStorage.getItem("profiles"))||[];
let currentProfileId=localStorage.getItem("currentProfileId");
let chart=null;

/* MENU */
function toggleProfileMenu(){
  profileMenu.style.left=profileMenu.style.left==="0px"?"-320px":"0px";
}
document.getElementById("openProfileMenu").onclick=toggleProfileMenu;

/* PROFILS */
function loadProfiles(){
  profileSelect.innerHTML="";
  profiles.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id; o.textContent=p.name;
    if(p.id===currentProfileId) o.selected=true;
    profileSelect.appendChild(o);
  });
  const a=profiles.find(p=>p.id===currentProfileId);
  if(a){
    profileName.value=a.name;
    profileSalaire.value=a.salaire;
    profileCharges.value=a.charges;
    salaireEl.value=a.salaire;
  }
}

function saveProfile(){
  const id=currentProfileId||Date.now().toString();
  const p={id,name:profileName.value||"Profil",salaire:+profileSalaire.value||0,charges:+profileCharges.value||0};
  const i=profiles.findIndex(x=>x.id===id);
  i>=0?profiles[i]=p:profiles.push(p);
  currentProfileId=id;
  localStorage.setItem("profiles",JSON.stringify(profiles));
  localStorage.setItem("currentProfileId",id);
  loadProfiles(); afficher();
}

function deleteProfile(){
  profiles=profiles.filter(p=>p.id!==currentProfileId);
  currentProfileId=null;
  localStorage.setItem("profiles",JSON.stringify(profiles));
  localStorage.removeItem("currentProfileId");
  loadProfiles(); afficher();
}

profileSelect.onchange=()=>{currentProfileId=profileSelect.value;localStorage.setItem("currentProfileId",currentProfileId);loadProfiles();afficher();};

/* LOGIQUE ORIGINALE */
function changerType(){
  blocImmoEl.classList.toggle("hidden",typeEl.value==="conso");
  blocConsoEl.classList.toggle("hidden",typeEl.value!=="conso");
}

function calculMensualite(c,t,d){
  let r=(t/100)/12,n=d*12;
  return c>0&&r>0?c*r/(1-Math.pow(1+r,-n)):0;
}

function ajouter(){
  let prix=0,apport=0,loyer=0,notaire=0,credit=0;
  if(typeEl.value==="immo"){
    prix=+prixEl.value||0;
    apport=+apportEl.value||0;
    loyer=+loyerEl.value||0;
    notaire=prix*0.0788555556;
    credit=Math.max(prix-apport,0);
  } else credit=+creditConsoEl.value||0;

  const m=calculMensualite(credit,+tauxEl.value||0,+dureeEl.value||0);
  data.push({nom:nomEl.value||"Projet",type:typeEl.value,prix,apport,notaire,argent:apport+notaire,credit,taux:+tauxEl.value||0,duree:+dureeEl.value||0,loyer,mensualite:m,cashflow:loyer-m});
  localStorage.setItem("credits_data",JSON.stringify(data));
  afficher();
}

function afficher(){
  const profil=profiles.find(p=>p.id===currentProfileId)||{salaire:0,charges:0};
  let salaire=profil.salaire;
  let html="",totalLoyers=0,totalMens=0;

  data.forEach((d,i)=>{
    totalLoyers+=d.loyer; totalMens+=d.mensualite;
    let base=salaire+(totalLoyers*(+tauxLoyerEl.value||0)/100);
    let end=base?(totalMens/base)*100:0;
    html+=`
<tr>
<td>${d.nom}</td><td>${d.type}</td><td>${d.prix}</td>
<td>${d.apport.toFixed(0)}</td><td>${d.notaire.toFixed(0)}</td>
<td>${d.argent.toFixed(0)}</td><td>${d.credit.toFixed(0)}</td>
<td>${d.taux}</td><td>${d.duree}</td>
<td>${d.loyer}</td><td>${d.mensualite.toFixed(2)}</td>
<td style="color:${end>=35?'red':'green'}">${end.toFixed(1)}%</td>
<td class="${d.cashflow>=0?'pos':'neg'}">${d.cashflow.toFixed(2)}</td>
<td><button class="delete" onclick="data.splice(${i},1);localStorage.setItem('credits_data',JSON.stringify(data));afficher()">üóëÔ∏è</button></td>
</tr>`;
  });

  lignesEl.innerHTML=html;
  const reste=salaire+totalLoyers-totalMens-profil.charges;
  revenuFinalEl.innerText=reste.toFixed(2)+" ‚Ç¨";

  const cashflow=totalLoyers-totalMens;
  const salaireAjuste=salaire+Math.min(cashflow,0);
  drawGraph(salaireAjuste,cashflow);
}

function drawGraph(salaire,cashflow){
  if(chart) chart.destroy();
  chart=new Chart(graphEl,{
    type:"bar",
    data:{labels:["Reste √† vivre"],datasets:[
      {label:"Salaire net",data:[salaire],backgroundColor:"gold",stack:"t",
       datalabels:{color:"#000",anchor:"center",align:"center",formatter:v=>v.toFixed(0)+" ‚Ç¨"}},
      {label:"Cashflow",data:[cashflow],backgroundColor:cashflow>=0?"green":"red",stack:"t",
       datalabels:{color:"#fff",anchor:"center",align:"center",formatter:v=>v?v.toFixed(0)+" ‚Ç¨":""}}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}},
    plugins:[ChartDataLabels]
  });
}

function exportPDF(){window.print();}

/* INIT */
changerType();
loadProfiles();
afficher();
</script>
</body>
</html>
