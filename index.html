<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007aff">

<!-- iOS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Cr√©dits">
<link rel="apple-touch-icon" href="icon-192.png">

<meta charset="UTF-8">
<title>Simulation cr√©dits immo & conso</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
html, body { height:100%; margin:0; padding:0; }
body { font-family:Arial; background:#f4f6f8; }
.box { background:white; padding:16px; min-height:100vh; position: relative; }

input, select, button {
  padding:10px;
  margin:3px;
  width:100%;
  font-size:16px;
}

.hidden { display:none; }

.table-container { overflow-x:auto; }

table {
  width:100%;
  border-collapse:collapse;
  font-size:13px;
  margin-top:20px;
}

th, td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}

th { background:#eee; }

button {
  background:#007aff;
  color:white;
  border:none;
  border-radius:5px;
}

.delete { background:red; }
.edit { background:orange; }
.pos { color:green; font-weight:bold; }
.neg { color:red; font-weight:bold; }

/* ‚úÖ GRAPHIQUE PLEINE LARGEUR */
#graph {
  image-rendering: crisp-edges;
  image-rendering: -webkit-optimize-contrast;
  width:100% !important;
  max-width:100%;
  height:300px !important;
  display:block;
}

.result {
  margin-top:15px;
  font-size:18px;
  font-weight:bold;
}

/* ‚úÖ IMPRESSION PROPRE (PAS D‚ÄôURL, PAS DE BOUTONS) */

@media screen {

  .graph-wrapper {
    height: 300px;          /* m√™me hauteur que le graph */
    position: relative;
  }

  .legend-vertical {
    top: 0;
    bottom: 0;
    right: 8px;

    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }

}


@media print {
  
  #graph {
    height: 260px !important;
  }

   h2 {
    margin-bottom: 5px;
  }

  .table-container {
    margin-bottom: 5px;
  }

  .graph-wrapper {
    height: 260px !important;   /* coh√©rent avec #graph print */
  position: relative;
  page-break-inside: avoid;
  break-inside: avoid;
}

  .legend-vertical {
    right: 0;
  
}

  /* R√©duire un peu les marges verticales */
  .result {
    margin-top: 5px;
    margin-bottom: 5px;
    font-size: 16px;
  }

  table {
    font-size: 12px;
  }
  button, input, select { display:none!important; }
  a[href]:after { content: "" !important; }
  .box {
    page-break-inside: avoid !important;
    break-inside: avoid !important; }
    
}

/* Safari iOS */
@page {
  size: A4 landscape;
  margin: 10mm;
}
/* === L√âGENDE VERTICALE PERSONNALIS√âE === */
.legend-vertical {
  position: absolute;
  top: 0;
  right: 5px;
  bottom: 0px;              /* ‚úÖ d√©part en bas */
  display: flex;
  flex-direction: column;
  gap: 25px;
  justify-content: space-between; /* üîë r√©partit sur toute la hauteur */
  pointer-events: none; /* √©vite toute interaction */
}

.legend-item {
  writing-mode: vertical-rl;   /* üîë texte vertical */
  transform: rotate(180deg);   /* sens de lecture normal */
  font-weight: bold;
  font-size: 11px;
  white-space: nowrap;
}

/* Couleurs */
.legend-item.salaire { color: gold; }
.legend-item.cashflow-pos { color: green; }
.legend-item.cashflow-neg { color: red; }

</style>
</head>

<body>

<div class="box">
<h2>Simulation cr√©dits (immobilier & conso)</h2>

<input id="salaire" type="number" placeholder="Salaire mensuel GLOBAL (‚Ç¨)">
<input id="tauxLoyer" type="number" value="70" placeholder="% loyer retenu">

<hr>

<input id="nom" placeholder="Nom du projet">

<select id="type" onchange="changerType()">
  <option value="immo">Cr√©dit immobilier</option>
  <option value="conso">Cr√©dit conso</option>
</select>

<div id="blocImmo">
  <input id="prix" type="number" placeholder="Prix d'achat">
  <input id="apport" type="number" placeholder="Apport personnel">
  <input id="loyer" type="number" placeholder="Loyer mensuel">
</div>

<div id="blocConso" class="hidden">
  <input id="creditConso" type="number" placeholder="Montant du cr√©dit conso">
</div>

<input id="taux" type="number" step="0.01" placeholder="Taux %">
<input id="duree" type="number" placeholder="Dur√©e (ann√©es)">

<button id="btnAjouter" onclick="ajouter()">Ajouter la ligne</button>
<button onclick="exportPDF()">Exporter en PDF</button>

<div class="table-container">
<table>
<thead>
<tr>
<th>Projet</th><th>Type</th><th>Prix</th><th>Apport</th><th>Notaire</th>
<th>Apport total</th><th>Cr√©dit</th><th>Taux</th><th>Dur√©e</th>
<th>Loyer</th><th>Mensualit√©</th><th>Endettement</th><th>Cashflow</th><th>Action</th>
</tr>
</thead>
<tbody id="lignes"></tbody>
</table>
</div>

<div class="result">
Reste √† vivre mensuel :
<span id="revenuFinalGlobal">0 ‚Ç¨</span>
</div>

<div class="graph-wrapper">
  <canvas id="graph"></canvas>

  <div class="legend-vertical">
    <div class="legend-item salaire">Salaire net</div>
    <div class="legend-item cashflow-pos">Cashflow positif</div>
    <div class="legend-item cashflow-neg">Cashflow n√©gatif</div>
  </div>
</div>


<script>
const salaireEl = document.getElementById("salaire");
const tauxLoyerEl = document.getElementById("tauxLoyer");
const nomEl = document.getElementById("nom");
const typeEl = document.getElementById("type");
const blocImmoEl = document.getElementById("blocImmo");
const blocConsoEl = document.getElementById("blocConso");
const prixEl = document.getElementById("prix");
const apportEl = document.getElementById("apport");
const loyerEl = document.getElementById("loyer");
const creditConsoEl = document.getElementById("creditConso");
const tauxEl = document.getElementById("taux");
const dureeEl = document.getElementById("duree");
const lignesEl = document.getElementById("lignes");
const revenuFinalEl = document.getElementById("revenuFinalGlobal");
const btnAjouter = document.getElementById("btnAjouter");
const graphEl = document.getElementById("graph");

let data = JSON.parse(localStorage.getItem("credits_data")) || [];
let chart;
let indexEdition = null;

/* Salaire persistant */
const SALAIRE_KEY = "salaire_global";

document.addEventListener("DOMContentLoaded", () => {
  const s = localStorage.getItem(SALAIRE_KEY);
  if (s) salaireEl.value = s;
  afficher();
});

salaireEl.addEventListener("input", () => {
  localStorage.setItem(SALAIRE_KEY, salaireEl.value || 0);
  afficher();
});

function changerType(){
  const isConso = typeEl.value === "conso";
  blocImmoEl.classList.toggle("hidden", isConso);
  blocConsoEl.classList.toggle("hidden", !isConso);
}

function calculMensualite(c,t,d){
  let r=(t/100)/12, n=d*12;
  return c>0 && r>0 ? c*r/(1-Math.pow(1+r,-n)) : 0;
}

function sauvegarder(){
  localStorage.setItem("credits_data", JSON.stringify(data));
}

function ajouter(){
  let prix=0, apport=0, loyer=0, notaire=0, credit=0;

  if(typeEl.value==="immo"){
    prix=+prixEl.value||0;
    apport=+apportEl.value||0;
    loyer=+loyerEl.value||0;
    notaire=prix*0.07885555555555556;
    credit=Math.max(prix-apport,0);
  } else {
    credit=+creditConsoEl.value||0;
  }

  let mensualite=calculMensualite(credit,+tauxEl.value||0,+dureeEl.value||0);

  const obj={
    nom:nomEl.value||"Projet",
    type:typeEl.value,
    prix, apport, notaire,
    argent:apport+notaire,
    credit,
    taux:+tauxEl.value||0,
    duree:+dureeEl.value||0,
    loyer,
    mensualite,
    cashflow:loyer-mensualite
  };

  if(indexEdition===null) data.push(obj);
  else {
    data[indexEdition]=obj;
    indexEdition=null;
    btnAjouter.innerText="Ajouter la ligne";
  }

  sauvegarder();
  afficher();
}

function afficher(){
  let html="", salaire=+salaireEl.value||0;
  let totalLoyers=0, totalMens=0;

  data.forEach((d,i)=>{
    totalLoyers+=d.loyer;
    totalMens+=d.mensualite;

    let base=salaire+(totalLoyers*(+tauxLoyerEl.value||0)/100);
    let end=base?(totalMens/base)*100:0;

    html+=`
    <tr>
      <td>${d.nom}</td><td>${d.type}</td><td>${d.prix}</td>
      <td>${d.apport.toFixed(0)}</td><td>${d.notaire.toFixed(0)}</td>
      <td>${d.argent.toFixed(0)}</td><td>${d.credit.toFixed(0)}</td>
      <td>${d.taux}</td><td>${d.duree}</td>
      <td>${d.loyer}</td><td>${d.mensualite.toFixed(2)}</td>
      <td style="color:${end>=35?'red':'green'}">${end.toFixed(1)}%</td>
      <td class="${d.cashflow>=0?'pos':'neg'}">${d.cashflow.toFixed(2)}</td>
      <td>
        <button class="edit" onclick="modifier(${i})">‚úèÔ∏è</button>
        <button class="delete" onclick="supprimer(${i})">üóëÔ∏è</button>
      </td>
    </tr>`;
  });

  lignesEl.innerHTML=html;

  let reste=salaire+totalLoyers-totalMens;
  revenuFinalEl.innerText=reste.toFixed(2)+" ‚Ç¨";

const cashflow = totalLoyers - totalMens;
const salaireAjuste = salaire + Math.min(cashflow, 0);

drawGraph(salaireAjuste, cashflow);
}

function modifier(i){
  const d=data[i];
  indexEdition=i;
  btnAjouter.innerText="Modifier la ligne";

  nomEl.value=d.nom;
  typeEl.value=d.type;
  changerType();
  prixEl.value=d.prix;
  apportEl.value=d.apport;
  loyerEl.value=d.loyer;
  creditConsoEl.value=d.credit;
  tauxEl.value=d.taux;
  dureeEl.value=d.duree;
}

function drawGraph(salaire,cashflow){
  if(chart) chart.destroy();

  chart = new Chart(graphEl,{
  type:"bar",
  data:{
    labels:["Reste √† vivre"],
    datasets:[
      {
        label:"Salaire net",
        data:[salaire],
        backgroundColor:"gold",
        stack:"t",
        datalabels:{
          color:"#000",
          anchor:"center",
          align:"center",
          rotation: 0,          // ‚úÖ TEXTE HORIZONTAL
          formatter:v => v.toFixed(0) + " ‚Ç¨"
        }
      },
      {
  label:"Cashflow",
  data:[cashflow],   // valeur positive OU n√©gative
  backgroundColor: cashflow >= 0 ? "green" : "red",
  stack:"t",
  datalabels:{
    color:"#fff",
    anchor:"center",
    align:"center",
    rotation: 0,          // ‚úÖ TEXTE HORIZONTAL
    formatter:v => v !== 0 ? v.toFixed(0) + " ‚Ç¨" : "",
    font:{ weight:"bold" }
  }
},
      
    ]
  },
  options:{
  responsive:true,
  maintainAspectRatio:false,
  devicePixelRatio: 3,
  layout:{
  padding:{ right:20 }
},

  plugins:{
    legend:{
    display:false,      // ‚ùå on d√©sactive la l√©gende native
    position:"right",   // ‚úÖ l√©gende √† droite
    labels:{
      font:{
        size:14,
        weight:"bold"
      },
      boxWidth:20,
      padding:12,
      lineHeight: 20   // ‚úÖ rend la l√©gende plus a√©r√©e
    }
  },
    datalabels:{
      font:{
        family:"Arial",
        weight:"bold",
        size:14
      }
    }
  },

  scales:{
    x:{
      stacked:true,
      ticks:{
        font:{ size:12 }
      }
    },
    y:{
      stacked:true,
      beginAtZero:true,
      ticks:{
        stepSize:1000,
        font:{ size:12 }
      }
    }
  }
}
,
  plugins:[ChartDataLabels]
});

}

function supprimer(i){
  data.splice(i,1);
  sauvegarder();
  afficher();
}

function exportPDF(){
  document.title = "";
  window.print();
}

changerType();
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>
<script>
window.addEventListener("beforeprint", () => {
  if (window.chart) window.chart.resize();
});

window.addEventListener("afterprint", () => {
  if (window.chart) window.chart.resize();
});
</script>



</body>
</html>
