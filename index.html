<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007aff">

<meta charset="UTF-8">
<title>Simulation crédits immo & conso</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.box { background:white; padding:20px; border-radius:10px; max-width:1600px; margin:auto; }
input, select, button { padding:6px warning; margin:3px; }
.hidden { display:none; }
table { width:100%; border-collapse: collapse; margin-top:20px; font-size:13px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#eee; }
.total { font-weight:bold; background:#fafafa; }
button { background:#007aff; color:white; border:none; border-radius:5px; cursor:pointer; }
.delete { background:red; }
.pos { color:green; font-weight:bold; }
.neg { color:red; font-weight:bold; }
canvas { margin-top:30px; }
.result {
    margin-top:15px;
    font-size:18px;
    font-weight:bold;
}
</style>
</head>

<body>

<div class="box">
<h2>Simulation crédits (immobilier & conso)</h2>

<!-- SALAIRE GLOBAL -->
<input id="salaire" type="number" placeholder="Salaire mensuel GLOBAL (€)">

<hr>

<!-- INPUTS -->
<input id="nom" placeholder="Nom du projet">

<select id="type" onchange="changerType()">
    <option value="immo">Crédit immobilier</option>
    <option value="conso">Crédit conso</option>
</select>

<div id="blocImmo">
    <input id="prix" type="number" placeholder="Prix d'achat">
    <input id="loyer" type="number" placeholder="Loyer mensuel">
</div>

<input id="credit" type="number" placeholder="Montant du crédit">
<input id="taux" type="number" step="0.01" placeholder="Taux %">
<input id="duree" type="number" placeholder="Durée (années)">

<button onclick="ajouter()">Ajouter la ligne</button>

<!-- TABLE -->
<table>
<thead>
<tr>
<th>Projet</th>
<th>Type</th>
<th>Prix</th>
<th>Apport</th>
<th>Notaire</th>
<th>Argent nécessaire</th>
<th>Crédit</th>
<th>Taux</th>
<th>Durée</th>
<th>Loyer</th>
<th>Mensualité</th>
<th>Endettement</th>
<th>Cashflow</th>
<th>Action</th>
</tr>
</thead>

<tbody id="lignes"></tbody>

<tfoot>
<tr class="total">
<td>Total</td>
<td>-</td>
<td id="tPrix">0</td>
<td id="tApport">0</td>
<td id="tNotaire">0</td>
<td id="tArgent">0</td>
<td id="tCredit">0</td>
<td>-</td>
<td>-</td>
<td id="tLoyer">0</td>
<td id="tMensualite">0</td>
<td id="tEndettement">0%</td>
<td id="tCashflow">0</td>
<td></td>
</tr>
</tfoot>
</table>

<!-- REVENU FINAL -->
<div class="result">
    Revenu final mensuel :
    <span id="revenuFinalGlobal">0 €</span>
</div>

<!-- GRAPHIQUE -->
<canvas id="graph"></canvas>

</div>

<script>
let data = JSON.parse(localStorage.getItem("credits")) || [];
let chart;

function changerType() {
    document.getElementById("blocImmo")
        .classList.toggle("hidden", type.value === "conso");
}

function calculMensualite(c, t, d) {
    let r = (t / 100) / 12;
    let n = d * 12;
    if (c <= 0 || r <= 0 || n <= 0) return 0;
    return c * r / (1 - Math.pow(1 + r, -n));
}

function ajouter() {
    let typeCredit = type.value;
    let salaire = Number(salaireEl().value) || 0;

    let credit = Number(creditEl().value) || 0;
    let taux = Number(tauxEl().value) || 0;
    let duree = Number(dureeEl().value) || 0;

    let prix = 0, loyer = 0, apport = 0, notaire = 0;

    if (typeCredit === "immo") {
        prix = Number(prixEl().value) || 0;
        loyer = Number(loyerEl().value) || 0;
        apport = prix * 0.10;
        notaire = prix * 0.08;
    }

    let mensualite = calculMensualite(credit, taux, duree);
    let cashflow = loyer - mensualite;

    data.push({
        nom: nom.value || "Projet",
        type: typeCredit,
        prix, apport, notaire,
        argent: apport + notaire,
        credit, taux, duree, loyer,
        mensualite, cashflow
    });

    localStorage.setItem("credits", JSON.stringify(data));
    afficher();
}

function afficher() {
    let html="", tp=0, ta=0, tn=0, tar=0, tc=0, tl=0, tm=0, tf=0;
    let salaire = Number(salaireEl().value) || 0;

    data.forEach((d,i)=>{
        tp+=d.prix; ta+=d.apport; tn+=d.notaire; tar+=d.argent;
        tc+=d.credit; tl+=d.loyer; tm+=d.mensualite; tf+=d.cashflow;

        html+=`
        <tr>
            <td>${d.nom}</td>
            <td>${d.type==="immo"?"Immo":"Conso"}</td>
            <td>${d.prix}</td>
            <td>${d.apport.toFixed(0)}</td>
            <td>${d.notaire.toFixed(0)}</td>
            <td>${d.argent.toFixed(0)}</td>
            <td>${d.credit}</td>
            <td>${d.taux}</td>
            <td>${d.duree}</td>
            <td>${d.loyer}</td>
            <td>${d.mensualite.toFixed(2)}</td>
            <td>–</td>
            <td class="${d.cashflow>=0?'pos':'neg'}">${d.cashflow.toFixed(2)}</td>
            <td><button class="delete" onclick="supprimer(${i})">X</button></td>
        </tr>`;
    });

    lignes.innerHTML = html;

    let endettement = salaire ? (tm / salaire) * 100 : 0;
    let revenuFinal = salaire + tf;

    tPrix.innerText = tp;
    tApport.innerText = ta.toFixed(0);
    tNotaire.innerText = tn.toFixed(0);
    tArgent.innerText = tar.toFixed(0);
    tCredit.innerText = tc;
    tLoyer.innerText = tl;
    tMensualite.innerText = tm.toFixed(2);
    tCashflow.innerText = tf.toFixed(2);
    tEndettement.innerText = endettement.toFixed(1) + "%";

    revenuFinalGlobal.innerText = revenuFinal.toFixed(2) + " €";

    drawGraph(tm, tf, revenuFinal);
}

function drawGraph(mens, cash, rev) {
    if (chart) chart.destroy();
    chart = new Chart(graph, {
        type: "bar",
        data: {
            labels: ["Mensualités", "Cashflow", "Revenu final"],
            datasets: [{
                label: "€ / mois",
                data: [mens, cash, rev]
            }]
        }
    });
}

function supprimer(i) {
    data.splice(i,1);
    localStorage.setItem("credits", JSON.stringify(data));
    afficher();
}

const prixEl=()=>prix;
const creditEl=()=>credit;
const tauxEl=()=>taux;
const dureeEl=()=>duree;
const loyerEl=()=>loyer;
const salaireEl=()=>salaire;

changerType();
afficher();
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
